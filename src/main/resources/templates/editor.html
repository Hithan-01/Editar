<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor - Editor de Texto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        #contenido { min-height: 500px; font-family: 'Georgia', serif; font-size: 16px; line-height: 1.6; }
        .editor-toolbar { background-color: #fff; border: 1px solid #dee2e6; border-radius: 8px 8px 0 0; }
        .editor-content { border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 8px 8px; }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark">
        <div class="container">
            <a th:href="@{/docs}" class="navbar-brand">
                <i class="bi bi-arrow-left me-2"></i>游닇 Editor de Texto
            </a>
            <div class="d-flex align-items-center text-white">
                <span class="me-3">Hola, <strong th:text="${usuario.nombreUsuario}">Usuario</strong></span>
                <form th:action="@{/logout}" method="post" class="d-inline">
                    <button type="submit" class="btn btn-outline-light btn-sm">Cerrar Sesi칩n</button>
                </form>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <h2 th:text="${esNuevo ? 'Nuevo Documento' : 'Editar Documento'}">Editor</h2>
                <p class="text-muted mb-4">Escribe y formatea tu documento</p>

                <!-- Formulario del editor -->
                <form th:action="${esNuevo ? '/docs/crear' : '/docs/' + documento.idDocumento + '/actualizar'}" method="post" onsubmit="prepareSubmit()">
                    <!-- Campo t칤tulo -->
                    <div class="mb-3">
                        <label for="titulo" class="form-label">T칤tulo del documento</label>
                        <input type="text" class="form-control form-control-lg" id="titulo" name="titulo" 
                               th:value="${documento?.titulo}" placeholder="Escribe el t칤tulo aqu칤..." required>
                    </div>

                    <!-- Toolbar del editor -->
                    <div class="editor-toolbar p-3">
                        <div class="btn-toolbar" role="toolbar">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="execCmd('bold')">
                                    <i class="bi bi-type-bold"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="execCmd('italic')">
                                    <i class="bi bi-type-italic"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="execCmd('underline')">
                                    <i class="bi bi-type-underline"></i>
                                </button>
                            </div>
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="execCmd('justifyLeft')">
                                    <i class="bi bi-text-left"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="execCmd('justifyCenter')">
                                    <i class="bi bi-text-center"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="execCmd('justifyRight')">
                                    <i class="bi bi-text-right"></i>
                                </button>
                            </div>
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="execCmd('insertUnorderedList')">
                                    <i class="bi bi-list-ul"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="execCmd('insertOrderedList')">
                                    <i class="bi bi-list-ol"></i>
                                </button>
                            </div>
                            <div class="btn-group">
                                <select class="form-select form-select-sm" onchange="execCmd('fontSize', this.value)">
                                    <option value="3">Tama침o</option>
                                    <option value="1">Muy peque침o</option>
                                    <option value="2">Peque침o</option>
                                    <option value="3" selected>Normal</option>
                                    <option value="4">Grande</option>
                                    <option value="5">Muy grande</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Editor de contenido -->
                    <div class="editor-content">
                        <div id="editor" contenteditable="true" class="p-4" 
                             th:utext="${documento?.contenido}">
                        </div>
                    </div>

                    <!-- Campo oculto para contenido -->
                    <input type="hidden" id="contenido" name="contenido">
                    
                    <!-- Campo oculto para detectar si es nuevo -->
                    <input type="hidden" name="esNuevo" th:value="${esNuevo}">

                    <!-- Botones de acci칩n -->
                    <div class="d-flex gap-3 mt-4">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-floppy me-2"></i>
                            <span th:text="${esNuevo ? 'Crear Documento' : 'Guardar Cambios'}">Guardar</span>
                        </button>
                        <a th:href="@{/docs}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle me-2"></i>Cancelar
                        </a>
                        <button type="button" class="btn btn-outline-info" onclick="previewDocument()">
                            <i class="bi bi-eye me-2"></i>Vista Previa
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de vista previa -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Vista Previa del Documento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h3 id="previewTitulo"></h3>
                    <hr>
                    <div id="previewContenido" style="font-family: Georgia, serif; line-height: 1.6;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Funciones del editor
        function execCmd(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('editor').focus();
        }

        // Preparar contenido antes de enviar
        function prepareSubmit() {
            const contenido = document.getElementById('editor').innerHTML;
            document.getElementById('contenido').value = contenido;
        }

        // Vista previa
        function previewDocument() {
            const titulo = document.getElementById('titulo').value || 'Sin t칤tulo';
            const contenido = document.getElementById('editor').innerHTML;
            
            document.getElementById('previewTitulo').textContent = titulo;
            document.getElementById('previewContenido').innerHTML = contenido;
            
            new bootstrap.Modal(document.getElementById('previewModal')).show();
        }

        // Configurar placeholder seg칰n el tipo de documento
        window.addEventListener('load', () => {
            const editor = document.getElementById('editor');
            // Obtener el valor desde el HTML (no desde Thymeleaf directamente)
            const esNuevoElement = document.querySelector('input[name="esNuevo"]');
            const esNuevo = esNuevoElement ? esNuevoElement.value === 'true' : false;
            
            // Si es nuevo documento y est치 vac칤o, mostrar placeholder
            if (esNuevo && (!editor.innerHTML || editor.innerHTML.trim() === '')) {
                editor.innerHTML = '<p class="text-muted">Comienza a escribir tu documento aqu칤...</p>';
                editor.style.minHeight = '400px';
            }
            
            // Limpiar placeholder al hacer clic
            editor.addEventListener('focus', function() {
                if (this.innerHTML.includes('Comienza a escribir tu documento aqu칤...')) {
                    this.innerHTML = '<p><br></p>';
                    this.focus();
                }
            });
            
            // Restaurar placeholder si queda vac칤o
            editor.addEventListener('blur', function() {
                if (this.innerHTML.trim() === '' || this.innerHTML === '<p><br></p>' || this.innerHTML === '<br>') {
                    if (esNuevo) {
                        this.innerHTML = '<p class="text-muted">Comienza a escribir tu documento aqu칤...</p>';
                    }
                }
            });
        });
    </script>
</body>
</html>